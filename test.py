import ubinascii
import gc
from lib.epd2in13_V4 import EPD_2in13_V4_Landscape

# --- Configuration ---
# Waveshare 2.13 V4 Landscape mode expects a buffer for 250x128 resolution.
# 250 * 128 bits / 8 bits/byte = 4000 bytes
REQUIRED_WIDTH = 250
REQUIRED_HEIGHT = 128
REQUIRED_SIZE = (REQUIRED_WIDTH * REQUIRED_HEIGHT) // 8
img_hex = "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff3ffffffffffffffffffffffffffffffffffffffffffffffe0fffffffffffffff3fe3fffffffffffffffffffffffffffffffffffffffffff807ffffffffff3fff3fe3fffffffffffffffffffffffffffffffffffffffffff0f7fffffffffe3fff3fffffffffffffffffffffffffffffffffffffffffffffe1fffffffffffe3fff3fffffffffffffffffffffffffffffffffffffffffffffe3fe0381c0381c0f0300e3ffffffffffffffffffffffffffffffffffffffffffe3fe03818c710c0e0300e3ffffffffffffffffffffffffffffffffffffffffffe3fff18f9c63ce3c7f3ce3ffffffffffffffffffffffffffffffffffffffffffe3fff19f9c67ce3c7f3ce3ffffffffffffffffffffffffffffffffffffffffffe3ff819f80e7c63cff3ce3ffffffffffffffffffffffffffffffffffffffffffe3fe019f81e7c63cff3ce3ffffffffffffffffffffffffffffffffffffffffffe3fe719f9fe7ce3cff3ce3fffffffffffffffffffffffffffffffffffffffffff1fe719f80638e3c7f3ce3fffffffffffffffffffffffffffffffffffffffffff006019f80300f0e033ce3fffffffffffffffffffffffffffffffffffffffffffc06019f1e383f0f033ce3ffffffffffffffffffffffffffffffffffffffffffffffffff3e3fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff80ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc000000000000000000000000000000000000000000000000000000000ffffffc000000000000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03fc3f80ffff87c07e01fff1fffc01fc03800f807ffffffffffffffffffffffc01f03f007ffe07801e00ffe1fffc01f803800f003ffffffffffffffffffffff820e03e083ffc078c1e007fe1fffc01f003800e0c3ffffffffffffffffffffff0f8e03e3e1ffc07fe1ff87fc1fffcffe1ffff0e3e1ffffffffffffffffffffff1f87c3c3e1fff87ff0ffc7f81fffcffe1ffff1c3e1ffffffffffffffffffffff1f87c3c7f1fff87ff0ffc7f01fff8ffe3fffe1e3e1ffffffffffffffffffffff1fc7c3c7f1fff87ff1ff87f01fff85fc3fffe1e1c3fffffffffffffffffffffe1fc7c3c7f1fff87fe1f80fe11fff803c007fe3f007fffffffffffffffffffffe1fc7c3c7f0fff87fe1f81fc31fff801c003fc3f80ffffffffffffffffffffffe1fc7c3c7f0c0387fc3f80fc71f019e0c1c1fc7f003fffffffffffffffffffffe1fc7c3c7f1c0387f87ff878f1f01ff0c3e1f87e1c1ffffffffffffffffffffff1fc7c3c7f1c0387f0fffc30f1f01ff8c3f1f87c3e1ffffffffffffffffffffff1f87c3c7f1fff87e1fffc30003ffff8c3f1f0fc7f1ffffffffffffffffffffff0f87c3c3e1fff87c1fffc30003ffff0e3e1f0fc7f1ffffffffffffffffffffff0f0fc3e3e1fff8783fff870007ffbe0e1e1f1fc3e1ffffffffffffffffffffff800fc3e003fff87800c007ff1fff801e003e1fe0c1ffffffffffffffffffffffc01fc3f007fff87000c00fff1fff003f007e1fe003ffffffffffffffffffffffe07fc3f80ffff87000e01fff1fffc07fc0fc3ff80fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7ffeffffbf87ff003e7cfff7ff9ffffffffffffffffffffffffffffffffffe037f7eff83bfffffe3f81ceff7019fffffffffffffffffffffffffffffffffffdf7f7eff79bc00ffe3fbdceff73f9fffffffffffffffffffffffffffffffffffcf1f7efe79bf8fffc9f3cceff73f9fffffffffffffffffffffffffffffffffff8f1f7efe7dbc31fe1c3bcceff73f9fffffffffffffffffffffffffffffffffff277f3eff79b8fcff7fb99ceff73f87fffffffffffffffffffffffffffffffffe737e3eff03b8007e001c3ceff73f87fffffffffffffffffffffffffffffffffcfb7e9effc7b8007e001fffeff73f9ffffffffffffffffffffffffffffffffffffffcceffefbfcffff7fefdeff73f9fffffffffffffffffffffffffffffffffff8079e6ffcfbc01ff80fcfce017009fffffffffffffffffffffffffffffffffffbf7bfefe00bffdff3e7c00e1f7839fffffffffffffffffffffffffffffffffffbf7ffeffffbc01ff7f3cfcfff7ff9dffffffffffffffffffffffffffffffffffbf7ffeffffbdffff3e7cfcfff7ff9dffffffffffffffffffffffffffffffffff807ffeffffbc00ff80fe00fff7ff9ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdbff6f7fffc01ff9f7ff6ff7f7ffdffd3fffffffffffffffffffffffffffffe05bbb6f7fffcfdfe077c76ff7f381de1d3e03cfffffffffffffffffffffffffe7dbbb6f7fffdfdfef37936ff003bfdffd3df9cfffffffffffffffffffffffffe7c3bb6f7fffdfdfef31bb6ff003bfdc0539fdcfffffffffffffffffffffffffe0c3bb6f007fcfdfef313b6ff7f381c7fd3bfdcfffffffffffffffffffffffffe7db832f007fc01fe777386ff7f3bfdf1d39fdcfffffffffffffffffffffffffe05bbb0ffffffffff077386ff007bede4c3cf9cfffffffffffffffffffffffffe1dbbb6c001f0007fff73b6fffff80dced3e07efffffffffffffffffffffffffffffbb6ffffffcfff007bb6fe001fffce53fffeffffffffffffffffffffffffff803836ffffffdfff007936ffe3fc01e4d3ef7effffffffffffffffffffffffffffb836f7fffddfffdefc76fff7fff9f1d3ef7fffffffffffffffffffffffffffffbff6f7fffdffffdcfff6fff7fffdffd3000cffffffffffffffffffffffffffffbff6f3fffcffffdcfff6fff7fffdffd3fffeffffffffffffffffffffffffffffbffef003fc01ff003ffefff7fffdfff3fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"

def update_display_from_buffer():
    hex_data = img_hex
    print("Processing image data...")
    try:
        buffer = bytearray(ubinascii.unhexlify(hex_data))
        
        current_len = len(buffer)
        print(f"Received data length: {current_len} bytes")

        if current_len < REQUIRED_SIZE:
            print(f"Warning: Buffer too short ({current_len}). Padding to {REQUIRED_SIZE} with white (0xFF).")
            # 모자란 만큼 0xFF(흰색)를 뒤에 추가
            padding_len = REQUIRED_SIZE - current_len
            buffer.extend(b'\xff' * padding_len)
            
        elif current_len > REQUIRED_SIZE:
             # 데이터가 너무 길면 잘못된 것이므로 에러 처리
             print(f"Error: Buffer too long ({current_len}). Expected {REQUIRED_SIZE}. Please check HTML canvas size.")
             return # 디스플레이 업데이트 중단

        epd = EPD_2in13_V4_Landscape()
        epd.init()
        # epd.Clear() # 속도를 위해 주석 처리 가능
        
        print(f"Displaying buffer of correct length: {len(buffer)}")
        epd.display(buffer)
        print("Putting display to sleep")
        epd.sleep()
        
        del epd
        del buffer
        gc.collect()
        
    except Exception as e:
        print(f"Display Error: {e}")

if __name__ == "__main__":
    update_display_from_buffer()