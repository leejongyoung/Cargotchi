import ubinascii
import gc
from lib.epd2in13_V4 import EPD_2in13_V4_Landscape

# 1. HTML 페이지에서 복사한 데이터를 이 변수에 붙여넣으세요.
# 예: img_hex = "ffffffff0000....." 
img_hex = "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff3ffffffffffffffffffffffffffffffffffffffffffffffe0fffffffffffffff3fe3fffffffffffffffffffffffffffffffffffffffffff807ffffffffff3fff3fe3fffffffffffffffffffffffffffffffffffffffffff0f7fffffffffe3fff3fffffffffffffffffffffffffffffffffffffffffffffe1fffffffffffe3fff3fffffffffffffffffffffffffffffffffffffffffffffe3fe0381c0381c0f0300e3ffffffffffffffffffffffffffffffffffffffffffe3fe03818c710c0e0300e3ffffffffffffffffffffffffffffffffffffffffffe3fff18f9c63ce3c7f3ce3ffffffffffffffffffffffffffffffffffffffffffe3fff19f9c67ce3c7f3ce3ffffffffffffffffffffffffffffffffffffffffffe3ff819f80e7c63cff3ce3ffffffffffffffffffffffffffffffffffffffffffe3fe019f81e7c63cff3ce3ffffffffffffffffffffffffffffffffffffffffffe3fe719f9fe7ce3cff3ce3fffffffffffffffffffffffffffffffffffffffffff1fe719f80638e3c7f3ce3fffffffffffffffffffffffffffffffffffffffffff006019f80300f0e033ce3fffffffffffffffffffffffffffffffffffffffffffc06019f1e383f0f033ce3ffffffffffffffffffffffffffffffffffffffffffffffffff3e3fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff80ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc000000000000000000000000000000000000000000000000000000000ffffffc000000000000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03fc3f80ffff87c07e01fff1fffc01fc03800f807ffffffffffffffffffffffc01f03f007ffe07801e00ffe1fffc01f803800f003ffffffffffffffffffffff820e03e083ffc078c1e007fe1fffc01f003800e0c3ffffffffffffffffffffff0f8e03e3e1ffc07fe1ff87fc1fffcffe1ffff0e3e1ffffffffffffffffffffff1f87c3c3e1fff87ff0ffc7f81fffcffe1ffff1c3e1ffffffffffffffffffffff1f87c3c7f1fff87ff0ffc7f01fff8ffe3fffe1e3e1ffffffffffffffffffffff1fc7c3c7f1fff87ff1ff87f01fff85fc3fffe1e1c3fffffffffffffffffffffe1fc7c3c7f1fff87fe1f80fe11fff803c007fe3f007fffffffffffffffffffffe1fc7c3c7f0fff87fe1f81fc31fff801c003fc3f80ffffffffffffffffffffffe1fc7c3c7f0c0387fc3f80fc71f019e0c1c1fc7f003fffffffffffffffffffffe1fc7c3c7f1c0387f87ff878f1f01ff0c3e1f87e1c1ffffffffffffffffffffff1fc7c3c7f1c0387f0fffc30f1f01ff8c3f1f87c3e1ffffffffffffffffffffff1f87c3c7f1fff87e1fffc30003ffff8c3f1f0fc7f1ffffffffffffffffffffff0f87c3c3e1fff87c1fffc30003ffff0e3e1f0fc7f1ffffffffffffffffffffff0f0fc3e3e1fff8783fff870007ffbe0e1e1f1fc3e1ffffffffffffffffffffff800fc3e003fff87800c007ff1fff801e003e1fe0c1ffffffffffffffffffffffc01fc3f007fff87000c00fff1fff003f007e1fe003ffffffffffffffffffffffe07fc3f80ffff87000e01fff1fffc07fc0fc3ff80fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7ffeffffbf87ff003e7cfff7ff9ffffffffffffffffffffffffffffffffffe037f7eff83bfffffe3f81ceff7019fffffffffffffffffffffffffffffffffffdf7f7eff79bc00ffe3fbdceff73f9fffffffffffffffffffffffffffffffffffcf1f7efe79bf8fffc9f3cceff73f9fffffffffffffffffffffffffffffffffff8f1f7efe7dbc31fe1c3bcceff73f9fffffffffffffffffffffffffffffffffff277f3eff79b8fcff7fb99ceff73f87fffffffffffffffffffffffffffffffffe737e3eff03b8007e001c3ceff73f87fffffffffffffffffffffffffffffffffcfb7e9effc7b8007e001fffeff73f9ffffffffffffffffffffffffffffffffffffffcceffefbfcffff7fefdeff73f9fffffffffffffffffffffffffffffffffff8079e6ffcfbc01ff80fcfce017009fffffffffffffffffffffffffffffffffffbf7bfefe00bffdff3e7c00e1f7839fffffffffffffffffffffffffffffffffffbf7ffeffffbc01ff7f3cfcfff7ff9dffffffffffffffffffffffffffffffffffbf7ffeffffbdffff3e7cfcfff7ff9dffffffffffffffffffffffffffffffffff807ffeffffbc00ff80fe00fff7ff9fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff007fe7dffcbfe01fffffffdffffff6ffffffffffffffffffffffffffffffffff3f3fc9df0cbfc01f007f81df003ef6f80fffffffffffffffffffffffffffffff7f3f9cde6cbfdfffff7ffddff3fef6f7e7ffffffffffffffffffffffffffffff7f3fbec664bfdfffff7ffddfe3fef6e7f7ffffffffffffffffffffffffffffff3f3fbec6f4bfdfffff7ffddfc8fef6eff7ffffffffffffffffffffffffffffff003f9cdef0bfc00fff7ff9de1e3e86e7f7ffffffffffffffffffffffffffffffffffc1def0bfffffef7ffbc67fbc76f3e7fffffffffffffffffffffffffffffe001fffdef4bfffffef7ff3dffffd76f81ffffffffffffffffffffffffffffffff3ffe01e64bf8007ef7fe7dc001936fffffffffffffffffffffffffffffffffff3ffe01f0cbffcffefff8fdff7f396fbdfffffffffffffffffffffffffffffff73fff7bf9cbffcffe7ffbfdff7f7f6fbdfffffffffffffffffffffffffffffff7ffff7bffcbffcfc001fffdff7fff6c0037fffffffffffffffffffffffffffff3ffff33ffcbffcffffffffdff7fff6ffff7fffffffffffffffffffffffffffff003fc00fffbffcffffffffdff7fffefffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"

def update_display_from_buffer(hex_data):
    print("Processing image data...")
    try:
        buffer = ubinascii.unhexlify(hex_data)
        
        # --- [안전장치 추가] ---
        # 2.13인치 V4가 보통 4000 바이트(250 * 128 / 8)를 요구하는 경우가 많습니다.
        # 데이터가 4000보다 작으면 뒤를 흰색(0xFF)으로 채웁니다.
        REQUIRED_SIZE = 4000 
        
        if len(buffer) < REQUIRED_SIZE:
            print(f"Warning: Buffer too short ({len(buffer)}). Padding to {REQUIRED_SIZE}...")
            # 모자란 만큼 0xFF(흰색)를 덧붙임
            padding_len = REQUIRED_SIZE - len(buffer)
            buffer = buffer + (b'\xff' * padding_len)
            
        elif len(buffer) > REQUIRED_SIZE:
             # 너무 길면 자름
             print(f"Warning: Buffer too long. Trimming...")
             buffer = buffer[:REQUIRED_SIZE]
        # ---------------------

        epd = EPD_2in13_V4_Landscape()
        epd.init()
        # epd.Clear() 
        
        print(f"Displaying buffer of length: {len(buffer)}")
        epd.display(buffer)
        epd.sleep()
        
        del epd
        del buffer
        gc.collect()
        
    except Exception as e:
        print(f"Display Error: {e}")

if __name__ == "__main__":
    update_display_from_buffer(img_hex)